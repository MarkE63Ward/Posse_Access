<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Creator</title>
  <style>
    :root{
      --bg:#728399;
      --card:#dde2e9;
      --muted:#6b7280;
      --accent:#2563eb;
      --accent-600:#1e40af;
      --success:#16a34a;
      --danger:#ef4444;
      --radius:12px;
      --divider:#cbe7ff;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(180deg, var(--bg), #eef3fb 120%);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:40px 20px;
      color:#0f172a;
    }
    .layout {
      width:1100px;
      max-width:100%;
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .card {
      background:var(--card);
      border-radius:var(--radius);
      padding:28px;
      box-shadow: 0 6px 20px rgba(16,24,40,0.06);
    }
    h1 { margin:0 0 10px 0; font-size:20px; letter-spacing:-0.2px; }
    p.lead { margin:0 0 18px 0; color:var(--muted); font-size:13px; }
    label { display:block; font-size:13px; margin-bottom:6px; color:#0f172a; font-weight:600; }
    input[type="text"], input[type="email"], select, .roles-input, textarea {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef8;
      background:#fff; box-sizing:border-box; outline:none; font-size:14px; margin-bottom:12px;
    }
    .small { font-size:12px; color:var(--muted); margin-top:-8px; margin-bottom:10px; }
    .row { display:flex; gap:10px; align-items:flex-end; }
    .col { flex:1; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:10px; background:var(--accent); color:#fff; border:none;
      cursor:pointer; font-weight:600; font-size:14px;
    }
    .btn.secondary { background:#f1f5f9; color:#0f172a; border:1px solid #e6eef8; }
    .btn.danger { background:var(--danger); color:#fff; }
    .username-preview {
      margin-top:6px; padding:10px; border-radius:8px; background:#f8fafc;
      border:1px dashed #e6eef8; font-weight:700; letter-spacing:0.2px;
    }
    .departments-add { display:flex; gap:8px; align-items:center; }
    .chip {
      display:inline-flex; align-items:center; gap:8px; padding:6px 8px;
      border-radius:999px; background:#eef2ff; color:#312e81; font-weight:600;
      margin-right:8px; margin-bottom:8px;
    }
    .roles-list { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
    table { width:100%; border-collapse:collapse; font-size:14px; min-width:900px; }
    thead th {
      text-align:left; padding:12px 8px; font-weight:700; color:var(--muted); font-size:12px;
      border-bottom:1px solid #eef2f7;
    }
    tbody td { padding:10px 8px; border-bottom:1px solid #f1f5f9; vertical-align:middle; }
    .muted { color:var(--muted); font-size:13px; }
    .controls { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .small-quiet { font-size:12px; color:#9aa7bf; }
    .divider { border-bottom:2px solid var(--divider); margin:20px 0; }
    @media (max-width:980px){ .layout { grid-template-columns: 1fr; } }

    /* small table for moved users */
    .moved-table { width:100%; border-collapse:collapse; margin-top:12px; }
    .moved-table th, .moved-table td { text-align:left; padding:8px; border-bottom:1px solid #e6eef8; }
    .moved-table th { background:#f1f5f9; font-weight:700; }
  </style>
</head>
<body>

  <div class="layout">
    <!-- Mode Selection -->
    <div class="card">
      <h1>Select Mode</h1>
      <p class="lead">Choose whether you are creating new users or listing users moving from Test to Production.</p>
      <div style="display:flex; gap:12px;">
        <button class="btn" id="modeNew">New User</button>
        <button class="btn secondary" id="modeMoved">User Moved from Test to Production</button>
      </div>
    </div>

    <!-- Moved Users Card (sibling to formCard) -->
    <div class="card" id="movedCard" style="display:none;">
      <h1>Users Moved from Test to Production</h1>
      <p class="lead">Enter a username and click <strong>Add user</strong>. Added usernames appear in the list below. When ready, click Generate Word Document.</p>

      <div style="display:flex; gap:8px; align-items:center;">
        <input id="movedUsername" type="text" placeholder="Enter the Username as it appears in Test" />
        <button class="btn" id="addMovedUser">Add user</button>
        <button class="btn secondary" id="clearMovedList" title="Clear moved list">Clear list</button>
      </div>

      <table class="moved-table" id="movedUsersTable" style="display:none;">
        <thead>
          <tr><th>Username</th><th style="width:110px">Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="controls" style="margin-top:12px;">
        <button class="btn" id="exportMovedDoc">Generate Word Document</button>
      </div>
    </div>

    <!-- LEFT: form -->
    <div class="card" id="formCard">
      <h1>User Creation Document</h1>
      <p class="lead">Paste full name, optionally add a prefix, choose department, roles, supervisor & email. Click <strong>Add user</strong> to populate the table at the bottom. Export creates a single document with the table.</p>

      <!-- Full name + unique toggle -->
      <div class="row">
        <div class="col">
          <label for="fullName">Full Name</label>
          <input id="fullName" type="text" placeholder="Enter Users First & Last Name" />
          <div class="username-preview" id="usernamePreview" style="display:none;">
            Username: <span id="usernameText"></span>
          </div>
        </div>
        <div class="col" style="flex:0 0 200px;">
          <label>Use unique pre-name identifier?</label>
          <div style="display:flex; gap:4px;">
            <button class="btn secondary" id="idYes">Yes</button>
            <button class="btn secondary" id="idNo">No</button>
          </div>
          <!-- identifier input is hidden until "Yes" is clicked -->
          <div id="identifierContainer" style="display:none; margin-top:6px;">
            <input id="identifierInput" type="text" placeholder="e.g. STR_" />
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="col">
          <label for="emailInput">Email</label>
          <input id="emailInput" type="email" placeholder="Enter Users Email" />
        </div>
        <div class="col">
          <label for="phoneInput">Phone Number</label>
          <input id="phoneInput" type="text" placeholder="e.g. 555-123-4567" />
        </div>
      </div>

      <div class="row">
        <div class="col" style="flex:0 0 40%;">
          <label for="supervisorInput">Supervisor</label>
          <input id="supervisorInput" type="text" placeholder="Supervisor Name" />
        </div>
        <div class="col" style="flex:0 0 60%;">
          <label for="departmentSelect">Department</label>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <select id="departmentSelect" style="flex:1;">
              <option value="Select Department">Select Department</option>
              <option value="ISC">ISC (Inspections Safety &amp; Compliance)</option>
              <option value="CLIP">CLIP</option>
              <option value="Dept of Commerce">Department of Commerce</option>
              <option value="Department of Planning & Development">Department of Planning & Development</option>
              <option value="Department of Public Health">Department of Public Health</option>
              <option value="Historical Commission">Historical Commission</option>
              <option value="L&I">L&amp;I</option>
              <option value="Law Department">Law Department</option>
              <option value="OIT">OIT</option>
              <option value="Office Of Property Assessment">Office Of Property Assessment</option>
              <option value="Office of Sustainability">Office of Sustainability</option>
              <option value="Office of the City Controller">Office of the City Controller</option>
              <option value="Pool Account">Pool Account</option>
              <option value="Philadelphia Fire Department">Philadelphia Fire Department</option>
              <option value="Philadelphia Water Department">Philadelphia Water Department</option>
              <option value="Philly311">Philly311</option>
              <option value="Quality of Life">Quality of Life</option>
              <option value="Revenue">Renvenue</option>
              <option value="Streets">Streets</option>
            </select>
            <button class="btn secondary" id="addDeptBtn">+ Add New</button>
          </div>

          <div id="addDeptArea" style="display:none; margin-bottom:12px;">
            <input id="newDeptName" type="text" placeholder="New Department Name" />
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
              <button class="btn secondary" id="cancelNewDept">Cancel</button>
              <button class="btn" id="saveNewDept">Save</button>
            </div>
          </div>
        </div>
      </div>

      <label for="rolesInput">Roles/Mimic</label>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <input id="rolesInput" class="roles-input" type="text" placeholder="Enter a role and press Add. You can add multiple roles." />
        <button class="btn secondary" id="addRoleBtn">Add More</button>
      </div>
      <div class="roles-list" id="rolesList" aria-live="polite"></div>

      <div style="display:flex; gap:10px; margin-top:6px;">
        <button class="btn" id="addUserBtn">Add user</button>
        <button class="btn secondary" id="clearFormBtn">Clear</button>
      </div>
      <div class="small-quiet" style="margin-top:10px;"></div>
    </div>

    <!-- RIGHT: table + export -->
    <div class="card" id="rightCard">
      <h1>Users Added</h1>
      <p class="lead">Added users appear here. You can remove rows, then export the list into a single Word document (.doc).</p>

      <div style="overflow:auto; max-height:65vh; border-radius:10px; border:1px solid #e5e7eb;">
        <table id="usersTable">
          <thead>
            <tr>
                <th>Name</th>
                <th style="width:160px">Username</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Supervisor</th>
                <th>Department</th>
                <th>Roles/Mimic</th>
                <th style="width:80px">Action</th>
            </tr>
            </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- give this controls div an id so we can hide it in Moved mode -->
      <div class="controls" id="rightControls" style="margin-top:12px;">
        <button class="btn secondary" id="exportCsv" title="Download CSV">Download CSV</button>
        <button class="btn" id="exportDoc">Export as Word (.doc)</button>
        <button class="btn" id="exportPdf">Export as PDF (.pdf)</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {

    // --- Helpers for name parsing and username generation ---
    const suffixes = ['jr','sr','ii','iii','iv','v','phd','md','esq','dr'];

    function normalizeToken(t){ return t.replace(/[\u2019']/g, "'").trim(); }

    function parseName(fullNameRaw){
      const raw = (fullNameRaw || '').trim();
      if(!raw) return null;
      const tokens = raw.split(/\s+/).map(normalizeToken).filter(Boolean);
      if(tokens.length === 0) return null;
      while(tokens.length > 1 && suffixes.includes(tokens[tokens.length - 1].replace(/\./g,'').toLowerCase())) tokens.pop();
      const firstName = tokens[0];
      const lastName = tokens[tokens.length - 1];
      return { firstName, lastName, tokens };
    }

    function normalizeLastNameForUsername(lastName){
      if(!lastName) return '';
      const lettersOnly = lastName.replace(/[-\s'’`]/g, '').replace(/[^A-Za-z]/g,'');
      if(!lettersOnly) return '';
      return lettersOnly.charAt(0).toUpperCase() + lettersOnly.slice(1);
    }

    function generateUsername(fullNameRaw, prefixRaw){
      const parsed = parseName(fullNameRaw);
      if(!parsed) return '';
      const firstInitial = parsed.firstName.charAt(0) ? parsed.firstName.charAt(0).toUpperCase() : '';
      const lastNorm = normalizeLastNameForUsername(parsed.lastName);
      const lastSix = lastNorm.slice(0,6);
      const base = `${lastSix}${firstInitial}1`;
      const prefix = (prefixRaw || '').trim();
      return prefix ? `${prefix}${base}` : base;
    }

    // --- DOM & state ---
    const fullNameEl = document.getElementById('fullName');
    const identifierContainer = document.getElementById('identifierContainer');
    const identifierInput = document.getElementById('identifierInput');
    const idYes = document.getElementById('idYes');
    const idNo = document.getElementById('idNo');
    const usernamePreview = document.getElementById('usernamePreview');
    const usernameText = document.getElementById('usernameText');

    const departmentSelect = document.getElementById('departmentSelect');
    const addDeptBtn = document.getElementById('addDeptBtn');
    const addDeptArea = document.getElementById('addDeptArea');
    const newDeptName = document.getElementById('newDeptName');
    const saveNewDept = document.getElementById('saveNewDept');
    const cancelNewDept = document.getElementById('cancelNewDept');

    const rolesInput = document.getElementById('rolesInput');
    const addRoleBtn = document.getElementById('addRoleBtn');
    const rolesListEl = document.getElementById('rolesList');

    const supervisorInput = document.getElementById('supervisorInput');
    const emailInput = document.getElementById('emailInput');
    const phoneInput = document.getElementById('phoneInput');

    const addUserBtn = document.getElementById('addUserBtn');
    const clearFormBtn = document.getElementById('clearFormBtn');

    const usersTableBody = document.querySelector('#usersTable tbody');
    const exportDocBtn = document.getElementById('exportDoc');
    const exportCsvBtn = document.getElementById('exportCsv');
    const exportPdfBtn = document.getElementById('exportPdf');
    const rightControls = document.getElementById('rightControls');

    let roles = [];
    let users = [];

    function refreshUsernamePreview(){
      const name = fullNameEl.value.trim();
      const prefix = identifierInput ? identifierInput.value.trim() : '';
      if(!name){
        usernamePreview.style.display = 'none';
        usernameText.textContent = '';
        return;
      }
      const username = generateUsername(name, prefix);
      usernameText.textContent = username || '(invalid name)';
      usernamePreview.style.display = 'block';
    }

    fullNameEl.addEventListener('input', refreshUsernamePreview);
    if (identifierInput) identifierInput.addEventListener('input', refreshUsernamePreview);

    // show/hide identifier input on Yes/No
    idYes.addEventListener('click', ()=>{
      if (identifierContainer) identifierContainer.style.display = 'block';
      if (identifierInput) { identifierInput.disabled = false; identifierInput.focus(); }
      idYes.classList.add('btn');
      idNo.classList.remove('btn');
      refreshUsernamePreview();
    });
    idNo.addEventListener('click', ()=>{
      if (identifierContainer) identifierContainer.style.display = 'none';
      if (identifierInput) { identifierInput.value = ''; identifierInput.disabled = true; }
      idNo.classList.add('btn');
      idYes.classList.remove('btn');
      refreshUsernamePreview();
    });


    // --- Roles management ---
    function renderRoles(){
      rolesListEl.innerHTML = '';
      roles.forEach((role, idx)=>{
        const div = document.createElement('div');
        div.className='chip';
        div.innerHTML = `${role} <button title="remove" style="background:none;border:none;cursor:pointer;font-weight:700;color:#374151;margin-left:6px" data-i="${idx}">✕</button>`;
        rolesListEl.appendChild(div);
      });
      // attach remove handlers
      Array.from(rolesListEl.querySelectorAll('button')).forEach(btn=>{
        btn.addEventListener('click', ()=>{ roles.splice(Number(btn.dataset.i),1); renderRoles(); });
      });
    }

    addRoleBtn.addEventListener('click', ()=>{
      const val = rolesInput.value.trim();
      if(val && !roles.includes(val)){ roles.push(val); renderRoles(); }
      rolesInput.value='';
      rolesInput.focus();
    });

    rolesInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addRoleBtn.click(); } });

    // --- Departments management ---
    addDeptBtn.addEventListener('click', ()=>{ addDeptArea.style.display='block'; newDeptName.focus(); });
    cancelNewDept.addEventListener('click', ()=>{ addDeptArea.style.display='none'; newDeptName.value=''; });
    saveNewDept.addEventListener('click', ()=>{
      const val = newDeptName.value.trim();
      if(val){
        const option = document.createElement('option'); option.value=val; option.textContent=val;
        departmentSelect.appendChild(option); departmentSelect.value=val; newDeptName.value=''; addDeptArea.style.display='none';
      }
    });

    // --- Users management ---
    function renderUsers(){
      usersTableBody.innerHTML='';
      users.forEach((u,idx)=>{
        const tr=document.createElement('tr');
        ['name','username','email','phone','supervisor','department','roles'].forEach(k=>{
          const td=document.createElement('td');
          td.textContent = k==='roles'?u.roles.join(', '):u[k];
          tr.appendChild(td);
        });
        const tdAction=document.createElement('td');
        const btn=document.createElement('button'); btn.className='btn secondary'; btn.textContent='Remove';
        btn.addEventListener('click',()=>{ users.splice(idx,1); renderUsers(); });
        tdAction.appendChild(btn); tr.appendChild(tdAction);
        usersTableBody.appendChild(tr);
      });
    }

    addUserBtn.addEventListener('click', ()=>{
      const name=fullNameEl.value.trim();
      if(!name) return alert('Full name required');
      const username = generateUsername(name, (identifierInput ? identifierInput.value.trim() : ''));
      users.push({
        username,name,department:departmentSelect.value,supervisor:supervisorInput.value,
        roles:[...roles],email:emailInput.value,phone:phoneInput.value
      });
      roles=[]; renderRoles(); renderUsers();
      fullNameEl.value=''; if (identifierInput) identifierInput.value=''; emailInput.value=''; phoneInput.value=''; supervisorInput.value=''; refreshUsernamePreview();
    });

    clearFormBtn.addEventListener('click', () => {
      // Clear all main inputs
      fullNameEl.value = '';
      if (identifierInput) identifierInput.value = '';
      emailInput.value = '';
      phoneInput.value = '';
      supervisorInput.value = '';
      
      // Reset roles
      roles = [];
      renderRoles();
    
      //Clears roles field
      rolesInput.value = '';
      
      // Reset username preview
      refreshUsernamePreview();
    
      // Reset identifier toggle to "No"
      if (identifierContainer) identifierContainer.style.display = 'none';
      if (identifierInput) identifierInput.disabled = true;
      idNo.classList.add('btn');
      idYes.classList.remove('btn');
    
      // Hide new department area if open
      addDeptArea.style.display = 'none';
      newDeptName.value = '';
    
      // Reset department select to first option
      if (departmentSelect.options.length > 0) departmentSelect.selectedIndex = 0;
    });

    // --- Export CSV ---
    exportCsvBtn.addEventListener('click', ()=>{
      if(users.length===0){ alert('No users to export'); return; }
      const rows = [['Username','Name','Department','Supervisor','Roles','Email','Phone']];
      users.forEach(u=>rows.push([u.username,u.name,u.department,u.supervisor,u.roles.join('; '),u.email,u.phone]));
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.map(v=>'="'+v.replace(/"/g,'""')+'"').join(',')).join('\n');
      const link=document.createElement('a'); link.setAttribute('href',csvContent); link.setAttribute('download','users.csv'); link.click();
    });

    // --- Export Word (for New User flow) ---
    exportDocBtn.addEventListener('click', ()=>{
      if(users.length===0){ alert('No users to export'); return; }

      let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office'
                    xmlns:w='urn:schemas-microsoft-com:office:word'
                    xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                      <meta charset='utf-8'>
                      <title>Users</title>
                      <style>
                        @page { size: landscape; }
                      </style>
                    </head>
                    <body>`;

      // Add heading and paragraph at the top
      html += `
        <h1 style="text-align:center; font-family:Arial, sans-serif;">User Creation Request</h1>
        <p style="text-align:center; font-family:Arial, sans-serif; font-size:14px;">
          Please add the following users and attributes to the users listed below
        </p>
        <div style="width:100%;">`;

      // User cards
      users.forEach((u) => {
      html += `
        <table style="width:100%; border-collapse:collapse; margin-bottom:12px;">
          <tr>
            <td>
              <table style="width:100%; border:1px solid #000; border-radius:8px; padding:8px; font-family:Arial, sans-serif; font-size:14px; border-collapse:collapse;">
                <tr>
                  <td style="width:50%; padding:4px;"><strong>Full Name:</strong> ${u.name}</td>
                  <td style="width:50%; padding:4px;"><strong>Username:</strong> ${u.username}</td>
                </tr>
                <tr>
                  <td style="padding:4px;"><strong>Supervisor:</strong> ${u.supervisor}</td>
                  <td style="padding:4px;"><strong>Department:</strong> ${u.department}</td>
                </tr>
                <tr>
                  <td style="padding:4px;"><strong>Email:</strong> ${u.email}</td>
                  <td style="padding:4px;"><strong>Phone:</strong> ${u.phone}</td>
                </tr>
                <tr>
                  <td colspan="2" style="padding:4px;"><strong>Roles:</strong> ${u.roles.join(', ')}</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      `;
    });

      html += '</div>'; // close cards container
      html += '</body></html>';

      const blob = new Blob(['\ufeff', html], {type:'application/msword'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'users.doc';
      link.click();
    });

    // --- Export PDF (for New User flow) ---
    exportPdfBtn.addEventListener('click', ()=> {
      if(users.length === 0){ alert('No users to export'); return; }

      const cardsHtml = users.map(u => `
        <table style="width:100%; border-collapse:collapse; margin-bottom:12px;">
          <tr>
            <td>
              <table style="width:100%; border:1px solid #000; border-radius:8px; padding:8px; font-family:Arial, sans-serif; font-size:14px; border-collapse:collapse;">
                <tr>
                  <td style="width:50%; padding:4px;"><strong>Full Name:</strong> ${u.name || ''}</td>
                  <td style="width:50%; padding:4px;"><strong>Username:</strong> ${u.username || ''}</td>
                </tr>
                <tr>
                  <td style="padding:4px;"><strong>Supervisor:</strong> ${u.supervisor || ''}</td>
                  <td style="padding:4px;"><strong>Department:</strong> ${u.department || ''}</td>
                </tr>
                <tr>
                  <td style="padding:4px;"><strong>Email:</strong> ${u.email || ''}</td>
                  <td style="padding:4px;"><strong>Phone:</strong> ${u.phone || ''}</td>
                </tr>
                <tr>
                  <td colspan="2" style="padding:4px;"><strong>Roles:</strong> ${ (u.roles && u.roles.length) ? u.roles.join(', ') : '' }</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      `).join('');

      const content = `
        <div style="font-family:Arial, sans-serif; padding:10px;">
          <h1 style="text-align:center; margin:6px 0 4px 0;">User Creation Request</h1>
          <p style="text-align:center; font-size:14px; margin:0 0 12px 0;">
            Please add the following users and attributes to the Test Enviornment for the users listed below:
          </p>
          <div style="width:100%;">${cardsHtml}</div>
        </div>
      `;

      const container = document.createElement('div');
      container.style.background = '#fff';
      container.style.padding = '8px';
      container.innerHTML = content;
      document.body.appendChild(container);

      const opt = {
        margin: 0.4,
        filename: `users_${new Date().toISOString().slice(0,10)}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
      };

      html2pdf().set(opt).from(container).save()
        .then(() => { document.body.removeChild(container); })
        .catch(err => { console.error(err); document.body.removeChild(container); });
    });

    // --- Mode Switching (show/hide form + moved UI; hide right-side exports during Moved mode) ---
    const modeNew = document.getElementById('modeNew');
    const modeMoved = document.getElementById('modeMoved');
    const formCard = document.getElementById('formCard');
    const movedCard = document.getElementById('movedCard');

    (function init(){ 
        idNo.classList.add('btn'); 
        if (identifierContainer) identifierContainer.style.display = 'none';
        if (identifierInput) identifierInput.disabled = true;

  // start in New User mode
  modeNew.classList.remove('secondary');
  modeMoved.classList.add('secondary');
  formCard.style.display = 'block';
  movedCard.style.display = 'none';
  rightControls.style.display = 'flex';
})();
    modeNew.addEventListener('click', () => {
  formCard.style.display = 'block';
  movedCard.style.display = 'none';
  rightCard.style.display = 'block';      // SHOW users added table
  rightControls.style.display = 'flex';   // show original exports
  modeNew.classList.remove('secondary');
  modeMoved.classList.add('secondary');
});

modeMoved.addEventListener('click', () => {
  formCard.style.display = 'none';
  movedCard.style.display = 'block';
  rightCard.style.display = 'none';       // HIDE users added table
  rightControls.style.display = 'none';   // hide original exports while in moved mode
  modeMoved.classList.remove('secondary');
  modeNew.classList.add('secondary');
});

    // --- Moved Users Add & Export ---
    const movedUsers = [];
    const movedTable = document.getElementById('movedUsersTable');
    const movedBody = movedTable.querySelector('tbody');
    const movedUsernameInput = document.getElementById('movedUsername');
    const addMovedUserBtn = document.getElementById('addMovedUser');
    const clearMovedListBtn = document.getElementById('clearMovedList');
    const exportMovedBtn = document.getElementById('exportMovedDoc');

    function renderMovedTable() {
      movedBody.innerHTML = '';
      if (movedUsers.length === 0) {
        movedTable.style.display = 'none';
        return;
      }

      movedTable.style.display = 'table';
      movedUsers.forEach((name, index) => {
        const row = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = name;
        const tdAction = document.createElement('td');
        const remBtn = document.createElement('button');
        remBtn.className = 'btn secondary';
        remBtn.textContent = 'Remove';
        remBtn.addEventListener('click', ()=> { removeMovedUser(index); });
        tdAction.appendChild(remBtn);
        row.appendChild(tdName);
        row.appendChild(tdAction);
        movedBody.appendChild(row);
      });
    }

    function removeMovedUser(index) {
      movedUsers.splice(index, 1);
      renderMovedTable();
    }

    addMovedUserBtn.addEventListener('click', ()=> {
      const username = movedUsernameInput.value.trim();
      if (!username) { alert('Please enter a username.'); return; }
      movedUsers.push(username);
      movedUsernameInput.value = '';
      movedUsernameInput.focus();
      renderMovedTable();
    });

    // also allow Enter key to add
    movedUsernameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); addMovedUserBtn.click(); }
    });

    clearMovedListBtn.addEventListener('click', ()=> {
      if (!movedUsers.length) return;
      if (!confirm('Clear all moved users?')) return;
      movedUsers.length = 0;
      renderMovedTable();
    });

    exportMovedBtn.addEventListener('click', ()=> {
      if (movedUsers.length === 0) { alert('Please add at least one user.'); return; }

      let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office'
                        xmlns:w='urn:schemas-microsoft-com:office:word'
                        xmlns='http://www.w3.org/TR/REC-html40'>
                        <head><meta charset='utf-8'><title>Reqest to Copy Users</title></head>
                        <body style="font-family:Arial, sans-serif;">`;

      html += `<h1 style="text-align:center;">Copy Users To Production Request</h1>
               <p style="text-align:left;">Please copy the following users & their attributes from the Test Enviornment to Production:</p>
               <ul style="font-size:14px; line-height:1.6;">`;

      movedUsers.forEach(name => {
        html += `<li>${name}</li>`;
      });

      html += `</ul>
      <p style="margin-top:10px;">No new account creation is required.</p>
      <p>Please confirm login credentials with <a href="mailto:Kimberly.Ladavich@phila.gov">Kimberly.Ladavich@phila.gov</a> &amp; <a href="mailto:Mark.EvansJR@phila.gov">Mark.EvansJR@phila.gov</a> once the accounts are created.</p>
      </body></html>`;

      const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
      const link = document.createElement('a');
      // add date in filename to be explicit
      const date = new Date().toISOString().slice(0,10);
      link.href = URL.createObjectURL(blob);
      link.download = `moved_users_${date}.doc`;
      link.click();
    });
});
    // done
  </script>
</body>
</html>
